<script>
  export default {
    data () {
      return {
        enabled: true,
        version: 'v3.1'
      }
    },

    oncreate () {
      const { id } = this.get()

      if (!id) {
        throw new Error(
          `id configuration parameter is required, try <FacebookPixel id="12345" /> or <FacebookPixel id="['12345', '67890']" /> for multiple pixels`
        )
      }

      const pixels = Array.isArray(id) ? id : [ id ]
      this.set({ pixels })

      if (window['fbq']) {
				this.set({ fbq: window['fbq']})
        return
      }
			
      const { version, track, enabled } = this.get()

      /* eslint-disable */
      const scr = (f, b, e, v, n, t, s) => {
        if (f.fbq) return; n = f.fbq = function () {
          n.callMethod ?
            n.callMethod.apply(n, arguments) : n.queue.push(arguments)
        };
        if (!f._fbq) f._fbq = n; n.push = n; n.loaded = !0; n.version = version;
        n.queue = [];
        t = b.createElement(e);
        t.async = true;
        t.defer = true;
        t.src = v;
        s = b.getElementsByTagName('body')[0];
        s.parentNode.appendChild(t, s);
      }
			
			scr(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js')
      /* eslint-enable */

			this.set({ fbq: window['fbq'] })
			
      if (enabled) {
        this.enable()
      }
    },

    methods: {
      enable () {
        this.init()
        this.track()
      },

      init () {
        const { pixels } = this.get()
        pixels.forEach(id => {
          this.query('init', id)
        })
      },

      track (event = 'PageView', data = undefined, id = undefined) {
        if (id) {
          const { pixels } = this.get()
          if (pixels.includes(id)) {
            this.query('trackSingle', id, event, data)
          } else {
            console.warn('Attempted to send event to unknown pixel', id)
          }
        } else {
          this.query('track', event, data)
        }
      },

      query (cmd, ...option) {
        const { fbq } = this.get()
        fbq(cmd, ...option)
      }
    }
  }
</script>
